# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

jobs:
- job: Windows
  pool:
    vmImage: 'windows-latest'
  steps:
  - powershell: |

      Install-PackageProvider Nuget –Force

      Install-Module –Name PowerShellGet –Force
      Update-Module -Name PowerShellGet


      Install-Module DockerMSFTProvider
      Import-Module -Name DockerMSFTProvider -Force
      Import-Packageprovider -Name DockerMSFTProvider -Force
      Find-Package docker
      Install-Package -Name Docker -Source DockerDefault 
      # Set LCOW_SUPPORTED Variable to 1 for enabled
      [Environment]::SetEnvironmentVariable("LCOW_SUPPORTED", "1", "Machine")
      
      Enable Experimental Features in Dockerd daemon.conf
      $configfile = @"
      {
         "experimental": true
      }
      "@
      $configfile|Out-File -FilePath C:\\ProgramData\\docker\\config\\daemon.json -Encoding ascii -Force
      
      
      
      Invoke-WebRequest -Uri "https://github.com/linuxkit/lcow/releases/download/v4.14.35-v0.3.9/release.zip" -UseBasicParsing -OutFile release.zip
      Expand-Archive release.zip -DestinationPath "$Env:ProgramFiles\Linux Containers\."

      
      restart-Service docker
      docker info
      get-content .\dockerfile.platform | docker build -
      docker images list
      get-content .\dockerfile.noplatform | docker build -
      docker images list
    displayName: 'Run all-the-things!'

